<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asistente de Derivadas - Pensamiento Matemático III</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE'
                    }
                }
            }
        }
    </script>
    <style>
        .formula-card {
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        .formula-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(93, 92, 222, 0.1), transparent);
            transition: left 0.5s ease;
        }
        .formula-card:hover::before {
            left: 100%;
        }
        .formula-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 15px 30px rgba(93, 92, 222, 0.3);
            border-color: #5D5CDE !important;
        }
        .formula-card:active {
            transform: scale(0.98);
        }
        .active-tab {
            background: linear-gradient(135deg, #5D5CDE 0%, #7B7AFF 100%);
            color: white;
        }
        .math-formula {
            font-size: 1.1rem;
            transition: all 0.3s ease;
        }
        .formula-card:hover .math-formula {
            transform: scale(1.05);
            color: #5D5CDE;
        }

        /* Modal para zoom de fórmula */
        .formula-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }
        .formula-modal-content {
            background: white;
            padding: 3rem;
            border-radius: 20px;
            max-width: 90%;
            max-height: 90%;
            overflow: auto;
            animation: zoomIn 0.3s ease;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        .dark .formula-modal-content {
            background: #1f2937;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes zoomIn {
            from {
                transform: scale(0.5);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }
        .click-hint {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(93, 92, 222, 0.9);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .formula-card:hover .click-hint {
            opacity: 1;
        }
    </style>
</head>
<body class="bg-white dark:bg-[#181818] text-gray-900 dark:text-gray-100 transition-colors">

    <!-- Header -->
    <header class="bg-gradient-to-r from-primary to-purple-600 text-white py-6 px-4 shadow-lg">
        <div class="max-w-6xl mx-auto">
            <h1 class="text-2xl md:text-3xl font-bold">📐 Asistente de Derivadas</h1>
            <p class="text-sm md:text-base mt-2 opacity-90">Pensamiento Matemático III - Guía Interactiva de Fórmulas</p>
        </div>
    </header>

    <div class="max-w-6xl mx-auto px-4 py-8">

        <!-- Navigation Tabs -->
        <div class="flex flex-wrap gap-2 mb-8">
            <button onclick="showSection('formulas')" id="tab-formulas" class="active-tab px-4 md:px-6 py-3 rounded-lg font-semibold transition-all text-base">
                📚 Fórmulas
            </button>
            <button onclick="showSection('selector')" id="tab-selector" class="bg-gray-200 dark:bg-gray-700 px-4 md:px-6 py-3 rounded-lg font-semibold transition-all hover:bg-gray-300 dark:hover:bg-gray-600 text-base">
                🎯 Selector
            </button>
            <button onclick="showSection('ejercicios')" id="tab-ejercicios" class="bg-gray-200 dark:bg-gray-700 px-4 md:px-6 py-3 rounded-lg font-semibold transition-all hover:bg-gray-300 dark:hover:bg-gray-600 text-base">
                📝 Ejercicios
            </button>
            <button onclick="showSection('quiz')" id="tab-quiz" class="bg-gray-200 dark:bg-gray-700 px-4 md:px-6 py-3 rounded-lg font-semibold transition-all hover:bg-gray-300 dark:hover:bg-gray-600 text-base">
                ✍️ Práctica
            </button>
        </div>

        <!-- Sección: Fórmulas -->
        <div id="section-formulas" class="space-y-6">
            <div class="bg-blue-50 dark:bg-blue-900/20 border-l-4 border-blue-500 p-4 rounded">
                <p class="text-base"><strong>💡 Tip del Profesor:</strong> Identifica primero el tipo de función, luego aplica la fórmula correspondiente.</p>
            </div>

            <!-- Categorías de Fórmulas -->
            <div class="space-y-4">

                <!-- Reglas Básicas -->
                <div class="bg-gray-50 dark:bg-gray-800 rounded-xl p-6 shadow-lg">
                    <h2 class="text-xl font-bold mb-4 text-primary">🔷 Reglas Básicas</h2>
                    <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div class="formula-card bg-white dark:bg-gray-700 p-4 rounded-lg border-2 border-gray-200 dark:border-gray-600" onclick="showFormulaModal('Constante', '\\(\\frac{d}{dx}(c) = 0\\)', 'La derivada de cualquier constante es cero.', 'Ejemplo: \\(\\frac{d}{dx}(5) = 0\\), \\(\\frac{d}{dx}(-12) = 0\\), \\(\\frac{d}{dx}(\\pi) = 0\\)')">
                            <span class="click-hint">👆 Click</span>
                            <h3 class="font-semibold mb-2 text-gray-700 dark:text-gray-200">🔷 Constante</h3>
                            <div class="math-formula">$$\frac{d}{dx}(c) = 0$$</div>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mt-2">Ejemplo: \(\frac{d}{dx}(5) = 0\)</p>
                        </div>
                        <div class="formula-card bg-white dark:bg-gray-700 p-4 rounded-lg border-2 border-gray-200 dark:border-gray-600">
                            <h3 class="font-semibold mb-2 text-gray-700 dark:text-gray-200">Identidad</h3>
                            <div class="math-formula">$$\frac{d}{dx}(x) = 1$$</div>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mt-2">La derivada de x es 1</p>
                        </div>
                        <div class="formula-card bg-white dark:bg-gray-700 p-4 rounded-lg border-2 border-gray-200 dark:border-gray-600">
                            <h3 class="font-semibold mb-2 text-gray-700 dark:text-gray-200">Regla de la Potencia</h3>
                            <div class="math-formula">$$\frac{d}{dx}(x^n) = nx^{n-1}$$</div>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mt-2">Ejemplo: \(\frac{d}{dx}(x^3) = 3x^2\)</p>
                        </div>
                        <div class="formula-card bg-white dark:bg-gray-700 p-4 rounded-lg border-2 border-gray-200 dark:border-gray-600">
                            <h3 class="font-semibold mb-2 text-gray-700 dark:text-gray-200">Múltiplo Constante</h3>
                            <div class="math-formula">$$\frac{d}{dx}(cu) = cu'$$</div>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mt-2">Ejemplo: \(\frac{d}{dx}(5x^2) = 5(2x) = 10x\)</p>
                        </div>
                        <div class="formula-card bg-white dark:bg-gray-700 p-4 rounded-lg border-2 border-gray-200 dark:border-gray-600">
                            <h3 class="font-semibold mb-2 text-gray-700 dark:text-gray-200">Función entre Constante</h3>
                            <div class="math-formula">$$\frac{d}{dx}\left(\frac{u}{c}\right) = \frac{u'}{c}$$</div>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mt-2">Ejemplo: \(\frac{d}{dx}\left(\frac{x^2}{3}\right) = \frac{2x}{3}\)</p>
                        </div>
                        <div class="formula-card bg-white dark:bg-gray-700 p-4 rounded-lg border-2 border-gray-200 dark:border-gray-600">
                            <h3 class="font-semibold mb-2 text-gray-700 dark:text-gray-200">Constante entre Función</h3>
                            <div class="math-formula">$$\frac{d}{dx}\left(\frac{c}{u}\right) = -\frac{cu'}{u^2}$$</div>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mt-2">Ejemplo: \(\frac{d}{dx}\left(\frac{5}{x}\right) = -\frac{5}{x^2}\)</p>
                        </div>
                    </div>
                </div>

                <!-- Funciones Trigonométricas -->
                <div class="bg-gray-50 dark:bg-gray-800 rounded-xl p-6 shadow-lg">
                    <h2 class="text-xl font-bold mb-4 text-purple-600 dark:text-purple-400">🔷 Funciones Trigonométricas</h2>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div class="formula-card bg-white dark:bg-gray-700 p-4 rounded-lg border-2 border-purple-200 dark:border-purple-600">
                            <h3 class="font-semibold mb-2 text-gray-700 dark:text-gray-200">Seno</h3>
                            <div class="math-formula">$$\frac{d}{dx}(\sin x) = \cos x$$</div>
                        </div>
                        <div class="formula-card bg-white dark:bg-gray-700 p-4 rounded-lg border-2 border-purple-200 dark:border-purple-600">
                            <h3 class="font-semibold mb-2 text-gray-700 dark:text-gray-200">Coseno</h3>
                            <div class="math-formula">$$\frac{d}{dx}(\cos x) = -\sin x$$</div>
                        </div>
                        <div class="formula-card bg-white dark:bg-gray-700 p-4 rounded-lg border-2 border-purple-200 dark:border-purple-600">
                            <h3 class="font-semibold mb-2 text-gray-700 dark:text-gray-200">Tangente</h3>
                            <div class="math-formula">$$\frac{d}{dx}(\tan x) = \sec^2 x$$</div>
                        </div>
                        <div class="formula-card bg-white dark:bg-gray-700 p-4 rounded-lg border-2 border-purple-200 dark:border-purple-600">
                            <h3 class="font-semibold mb-2 text-gray-700 dark:text-gray-200">Cotangente</h3>
                            <div class="math-formula">$$\frac{d}{dx}(\cot x) = -\csc^2 x$$</div>
                        </div>
                        <div class="formula-card bg-white dark:bg-gray-700 p-4 rounded-lg border-2 border-purple-200 dark:border-purple-600">
                            <h3 class="font-semibold mb-2 text-gray-700 dark:text-gray-200">Secante</h3>
                            <div class="math-formula">$$\frac{d}{dx}(\sec x) = \sec x \tan x$$</div>
                        </div>
                        <div class="formula-card bg-white dark:bg-gray-700 p-4 rounded-lg border-2 border-purple-200 dark:border-purple-600">
                            <h3 class="font-semibold mb-2 text-gray-700 dark:text-gray-200">Cosecante</h3>
                            <div class="math-formula">$$\frac{d}{dx}(\csc x) = -\csc x \cot x$$</div>
                        </div>
                    </div>
                </div>

                <!-- Funciones Exponenciales y Logarítmicas -->
                <div class="bg-gray-50 dark:bg-gray-800 rounded-xl p-6 shadow-lg">
                    <h2 class="text-xl font-bold mb-4 text-green-600 dark:text-green-400">🔷 Exponenciales y Logaritmos</h2>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div class="formula-card bg-white dark:bg-gray-700 p-4 rounded-lg border-2 border-green-200 dark:border-green-600">
                            <h3 class="font-semibold mb-2 text-gray-700 dark:text-gray-200">Exponencial natural</h3>
                            <div class="math-formula">$$\frac{d}{dx}(e^x) = e^x$$</div>
                        </div>
                        <div class="formula-card bg-white dark:bg-gray-700 p-4 rounded-lg border-2 border-green-200 dark:border-green-600">
                            <h3 class="font-semibold mb-2 text-gray-700 dark:text-gray-200">Exponencial base a</h3>
                            <div class="math-formula">$$\frac{d}{dx}(a^x) = a^x \ln a$$</div>
                        </div>
                        <div class="formula-card bg-white dark:bg-gray-700 p-4 rounded-lg border-2 border-green-200 dark:border-green-600">
                            <h3 class="font-semibold mb-2 text-gray-700 dark:text-gray-200">Logaritmo natural</h3>
                            <div class="math-formula">$$\frac{d}{dx}(\ln x) = \frac{1}{x}$$</div>
                        </div>
                        <div class="formula-card bg-white dark:bg-gray-700 p-4 rounded-lg border-2 border-green-200 dark:border-green-600">
                            <h3 class="font-semibold mb-2 text-gray-700 dark:text-gray-200">Logaritmo base a</h3>
                            <div class="math-formula">$$\frac{d}{dx}(\log_a x) = \frac{1}{x \ln a}$$</div>
                        </div>
                    </div>
                </div>

                <!-- Reglas de Operación -->
                <div class="bg-gray-50 dark:bg-gray-800 rounded-xl p-6 shadow-lg">
                    <h2 class="text-xl font-bold mb-4 text-orange-600 dark:text-orange-400">🔷 Reglas de Operación</h2>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div class="formula-card bg-white dark:bg-gray-700 p-4 rounded-lg border-2 border-orange-200 dark:border-orange-600">
                            <h3 class="font-semibold mb-2 text-gray-700 dark:text-gray-200">Suma/Resta</h3>
                            <div class="math-formula">$$\frac{d}{dx}(u \pm v) = u' \pm v'$$</div>
                        </div>
                        <div class="formula-card bg-white dark:bg-gray-700 p-4 rounded-lg border-2 border-orange-200 dark:border-orange-600">
                            <h3 class="font-semibold mb-2 text-gray-700 dark:text-gray-200">Regla del Producto</h3>
                            <div class="math-formula">$$\frac{d}{dx}(u \cdot v) = u' \cdot v + u \cdot v'$$</div>
                        </div>
                        <div class="formula-card bg-white dark:bg-gray-700 p-4 rounded-lg border-2 border-orange-200 dark:border-orange-600">
                            <h3 class="font-semibold mb-2 text-gray-700 dark:text-gray-200">Regla del Cociente</h3>
                            <div class="math-formula">$$\frac{d}{dx}\left(\frac{u}{v}\right) = \frac{u' \cdot v - u \cdot v'}{v^2}$$</div>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mt-2">Ejemplo: \(\frac{d}{dx}\left(\frac{x^2}{\sin x}\right)\)</p>
                        </div>
                        <div class="formula-card bg-white dark:bg-gray-700 p-4 rounded-lg border-2 border-orange-200 dark:border-orange-600">
                            <h3 class="font-semibold mb-2 text-gray-700 dark:text-gray-200">Potencia de una Función</h3>
                            <div class="math-formula">$$\frac{d}{dx}(u^n) = n \cdot u^{n-1} \cdot u'$$</div>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mt-2">Ejemplo: \(\frac{d}{dx}((x^2+1)^3)\)</p>
                        </div>
                        <div class="formula-card bg-white dark:bg-gray-700 p-4 rounded-lg border-2 border-orange-200 dark:border-orange-600">
                            <h3 class="font-semibold mb-2 text-gray-700 dark:text-gray-200">Regla de la Cadena</h3>
                            <div class="math-formula">$$\frac{d}{dx}(u(v(x))) = u'(v(x)) \cdot v'(x)$$</div>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mt-2">Ejemplo: \(\frac{d}{dx}(\sin(x^2))\)</p>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- Sección: Selector Interactivo -->
        <div id="section-selector" class="hidden">
            <div class="bg-gradient-to-r from-blue-50 to-purple-50 dark:from-blue-900/20 dark:to-purple-900/20 rounded-xl p-6 shadow-lg mb-6">
                <h2 class="text-2xl font-bold mb-4">🎯 Selector Inteligente de Fórmulas</h2>
                <p class="text-base mb-4">Ingresa tu función y te ayudaré a identificar qué fórmula usar:</p>

                <div class="space-y-4">
                    <div>
                        <label class="block font-semibold mb-2 text-base">Escribe tu función:</label>
                        <input type="text" id="functionInput" placeholder="Ejemplo: (x^2+1)^3, sin(x), x^2/sin(x), 5/x..."
                               class="w-full px-4 py-3 text-base border-2 border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 focus:border-primary focus:outline-none">
                    </div>

                    <button onclick="analyzeFunction()"
                            class="w-full bg-gradient-to-r from-primary to-purple-600 text-white px-6 py-3 rounded-lg font-bold hover:shadow-lg transition-all text-base">
                        🔍 Analizar Función
                    </button>
                </div>
            </div>

            <div id="analysisResult" class="hidden">
                <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-lg">
                    <h3 class="text-xl font-bold mb-4 text-primary">📊 Análisis de tu función:</h3>
                    <div id="resultContent" class="space-y-4"></div>
                </div>
            </div>
        </div>

        <!-- Sección: Ejercicios -->
        <div id="section-ejercicios" class="hidden">
            <div class="bg-gradient-to-r from-purple-50 to-pink-50 dark:from-purple-900/20 dark:to-pink-900/20 rounded-xl p-6 shadow-lg mb-6">
                <h2 class="text-2xl font-bold mb-4">📝 Ejercicios de Práctica</h2>
                <p class="text-base mb-4">Resuelve los siguientes 20 ejercicios. Identifica los datos, la fórmula y encuentra la derivada.</p>
            </div>

            <!-- Ejemplo de cómo resolver -->
            <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-lg mb-6 border-4 border-primary">
                <h3 class="text-xl font-bold mb-4 text-primary">📌 Ejemplo de Resolución</h3>

                <div class="mb-4">
                    <p class="font-semibold mb-2 text-base">Función:</p>
                    <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg text-lg">
                        $$f(x) = 3x^5$$
                    </div>
                </div>

                <div class="bg-blue-50 dark:bg-blue-900/20 border-l-4 border-blue-500 p-4 rounded mb-4">
                    <p class="font-bold mb-2 text-base">Paso 1: Identificación de datos</p>
                    <ul class="list-disc ml-6 space-y-1">
                        <li>Tipo de función: Múltiplo constante</li>
                        <li>$$c = 3$$ (constante)</li>
                        <li>$$u = x^5$$ (función)</li>
                        <li>$$u' = 5x^4$$ (derivada de la función)</li>
                    </ul>
                </div>

                <div class="bg-purple-50 dark:bg-purple-900/20 border-l-4 border-purple-500 p-4 rounded mb-4">
                    <p class="font-bold mb-2 text-base">Paso 2: Fórmula a utilizar</p>
                    <div class="text-lg">
                        $$\frac{d}{dx}(cu) = cu'$$
                    </div>
                </div>

                <div class="bg-green-50 dark:bg-green-900/20 border-l-4 border-green-500 p-4 rounded">
                    <p class="font-bold mb-2 text-base">Paso 3: Respuesta</p>
                    <div class="text-lg">
                        $$f'(x) = 3(5x^4) = 15x^4$$
                    </div>
                </div>
            </div>

            <!-- Contenedor de ejercicios -->
            <div id="exercisesContainer" class="space-y-4">
                <!-- Los ejercicios se generarán dinámicamente -->
            </div>
        </div>

        <!-- Sección: Quiz de Práctica -->
        <div id="section-quiz" class="hidden">
            <div class="bg-gradient-to-r from-green-50 to-blue-50 dark:from-green-900/20 dark:to-blue-900/20 rounded-xl p-6 shadow-lg mb-6">
                <h2 class="text-2xl font-bold mb-4">✍️ Práctica Guiada</h2>
                <p class="text-base mb-4">Resuelve estos ejercicios para practicar la identificación de fórmulas:</p>
            </div>

            <div id="quizContainer" class="space-y-6">
                <!-- Los ejercicios se generarán dinámicamente -->
            </div>

            <div class="flex gap-4 mt-6">
                <button onclick="generateQuiz()"
                        class="flex-1 bg-gradient-to-r from-primary to-purple-600 text-white px-6 py-3 rounded-lg font-bold hover:shadow-lg transition-all text-base">
                    🔄 Nuevos Ejercicios
                </button>
                <button onclick="checkAnswers()"
                        class="flex-1 bg-green-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-green-700 transition-all text-base">
                    ✅ Verificar Respuestas
                </button>
            </div>

            <div id="quizResults" class="hidden mt-6 p-6 rounded-xl"></div>
        </div>

    </div>

    <script>
        // Dark mode support
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // Navegación entre secciones
        function showSection(section) {
            // Ocultar todas las secciones
            document.querySelectorAll('[id^="section-"]').forEach(el => el.classList.add('hidden'));
            // Mostrar sección seleccionada
            document.getElementById(`section-${section}`).classList.remove('hidden');

            // Actualizar tabs
            document.querySelectorAll('[id^="tab-"]').forEach(el => {
                el.classList.remove('active-tab');
                el.classList.add('bg-gray-200', 'dark:bg-gray-700');
            });
            document.getElementById(`tab-${section}`).classList.add('active-tab');
            document.getElementById(`tab-${section}`).classList.remove('bg-gray-200', 'dark:bg-gray-700');
        }

        // Analizador de funciones
        function analyzeFunction() {
            const input = document.getElementById('functionInput').value.toLowerCase().trim();
            const resultDiv = document.getElementById('analysisResult');
            const contentDiv = document.getElementById('resultContent');

            if (!input) {
                showCustomAlert('Por favor ingresa una función');
                return;
            }

            let analysis = '';
            let formula = '';
            let example = '';

            // Análisis de patrones
            if (input === 'x') {
                formula = '\\(\\frac{d}{dx}(x) = 1\\)';
                example = 'La derivada de x es simplemente 1';
                analysis = '✅ <strong>Tipo:</strong> Identidad<br>✅ <strong>Fórmula:</strong> ' + formula + '<br>✅ <strong>Explicación:</strong> ' + example;
            }
            else if (!isNaN(input)) {
                formula = '\\(\\frac{d}{dx}(c) = 0\\)';
                example = 'Cualquier constante tiene derivada cero';
                analysis = '✅ <strong>Tipo:</strong> Constante<br>✅ <strong>Fórmula:</strong> ' + formula + '<br>✅ <strong>Explicación:</strong> ' + example;
            }
            else if (input.includes('x^') || input.includes('x²') || input.includes('x³')) {
                formula = '\\(\\frac{d}{dx}(x^n) = nx^{n-1}\\)';
                example = 'Para \\(x^3\\), la derivada sería \\(3x^2\\)';
                analysis = '✅ <strong>Tipo:</strong> Potencia<br>✅ <strong>Fórmula:</strong> ' + formula + '<br>✅ <strong>Ejemplo:</strong> ' + example;
            }
            else if (input.includes('sin') || input.includes('sen')) {
                formula = '\\(\\frac{d}{dx}(\\sin x) = \\cos x\\)';
                analysis = '✅ <strong>Tipo:</strong> Función Trigonométrica (Seno)<br>✅ <strong>Fórmula:</strong> ' + formula;
            }
            else if (input.includes('cos')) {
                formula = '\\(\\frac{d}{dx}(\\cos x) = -\\sin x\\)';
                analysis = '✅ <strong>Tipo:</strong> Función Trigonométrica (Coseno)<br>✅ <strong>Fórmula:</strong> ' + formula + '<br>⚠️ <strong>Nota:</strong> No olvides el signo negativo';
            }
            else if (input.includes('tan')) {
                formula = '\\(\\frac{d}{dx}(\\tan x) = \\sec^2 x\\)';
                analysis = '✅ <strong>Tipo:</strong> Función Trigonométrica (Tangente)<br>✅ <strong>Fórmula:</strong> ' + formula;
            }
            else if (input.includes('e^x') || input === 'e^x') {
                formula = '\\(\\frac{d}{dx}(e^x) = e^x\\)';
                example = 'La exponencial natural es su propia derivada';
                analysis = '✅ <strong>Tipo:</strong> Exponencial Natural<br>✅ <strong>Fórmula:</strong> ' + formula + '<br>✅ <strong>Nota especial:</strong> ' + example;
            }
            else if (input.includes('ln')) {
                formula = '\\(\\frac{d}{dx}(\\ln x) = \\frac{1}{x}\\)';
                analysis = '✅ <strong>Tipo:</strong> Logaritmo Natural<br>✅ <strong>Fórmula:</strong> ' + formula;
            }
            else if (input.includes('log')) {
                formula = '\\(\\frac{d}{dx}(\\log_a x) = \\frac{1}{x \\ln a}\\)';
                analysis = '✅ <strong>Tipo:</strong> Logaritmo (base a)<br>✅ <strong>Fórmula:</strong> ' + formula;
            }
            else if (input.match(/\([^)]+\)\^/) || input.match(/\([^)]+\)\*\*/) || input.includes('sen(') || input.includes('cos(')) {
                formula = '\\(\\frac{d}{dx}(u^n) = n \\cdot u^{n-1} \\cdot u\'\\)';
                example = 'Para \\((x^2+1)^3\\), identifica u = x²+1, n = 3, u\' = 2x';
                analysis = '✅ <strong>Tipo:</strong> Potencia de una Función<br>✅ <strong>Fórmula:</strong> ' + formula + '<br>✅ <strong>Explicación:</strong> ' + example + '<br>✅ <strong>Tip:</strong> Multiplica por el exponente, baja el exponente en 1, y multiplica por la derivada de la función interior (u\')';
            }
            else if (input.includes('*') || input.includes('·')) {
                formula = '\\(\\frac{d}{dx}(u \\cdot v) = u\' \\cdot v + u \\cdot v\'\\)';
                analysis = '✅ <strong>Tipo:</strong> Producto de funciones<br>✅ <strong>Fórmula (Regla del Producto):</strong> ' + formula + '<br>✅ <strong>Tip:</strong> Deriva la primera (u\') y multiplica por la segunda (v), más la primera (u) por la derivada de la segunda (v\')';
            }
            else if (input.includes('/')) {
                formula = '\\(\\frac{d}{dx}\\left(\\frac{u}{v}\\right) = \\frac{u\' \\cdot v - u \\cdot v\'}{v^2}\\)';
                analysis = '✅ <strong>Tipo:</strong> Cociente de funciones<br>✅ <strong>Fórmula (Regla del Cociente):</strong> ' + formula + '<br>✅ <strong>Tip:</strong> "Abajo (v) por arriba derivada (u\') menos arriba (u) por abajo derivada (v\'), todo sobre abajo al cuadrado (v²)"';
            }
            else {
                analysis = '🤔 <strong>No pude identificar la función exacta</strong><br><br>💡 <strong>Sugerencias:</strong><br>' +
                          '• Verifica la sintaxis (usa x^2 para potencias)<br>' +
                          '• Para funciones compuestas usa paréntesis: (x^2+1)^3<br>' +
                          '• Asegúrate de usar términos como: sin, cos, tan, e^x, ln, log<br>' +
                          '• Para cocientes usa /: x^2/sin(x)<br>' +
                          '• Revisa la sección de Fórmulas para más ejemplos';
            }

            contentDiv.innerHTML = '<div class="bg-blue-50 dark:bg-blue-900/30 p-4 rounded-lg border-l-4 border-primary">' + analysis + '</div>';
            resultDiv.classList.remove('hidden');

            // Re-render MathJax
            if (window.MathJax) {
                MathJax.typesetPromise([contentDiv]);
            }
        }

        // Base de datos de ejercicios
        const quizDatabase = [
            { function: '\\(f(x) = 7\\)', type: 'Constante', formula: '\\(\\frac{d}{dx}(c) = 0\\)' },
            { function: '\\(f(x) = x^5\\)', type: 'Potencia', formula: '\\(\\frac{d}{dx}(x^n) = nx^{n-1}\\)' },
            { function: '\\(f(x) = \\sin x\\)', type: 'Seno', formula: '\\(\\frac{d}{dx}(\\sin x) = \\cos x\\)' },
            { function: '\\(f(x) = \\cos x\\)', type: 'Coseno', formula: '\\(\\frac{d}{dx}(\\cos x) = -\\sin x\\)' },
            { function: '\\(f(x) = e^x\\)', type: 'Exponencial', formula: '\\(\\frac{d}{dx}(e^x) = e^x\\)' },
            { function: '\\(f(x) = \\ln x\\)', type: 'Logaritmo', formula: '\\(\\frac{d}{dx}(\\ln x) = \\frac{1}{x}\\)' },
            { function: '\\(f(x) = \\tan x\\)', type: 'Tangente', formula: '\\(\\frac{d}{dx}(\\tan x) = \\sec^2 x\\)' },
            { function: '\\(f(x) = 3x^2\\)', type: 'Potencia', formula: '\\(\\frac{d}{dx}(x^n) = nx^{n-1}\\)' },
            { function: '\\(f(x) = x^{-2}\\)', type: 'Potencia', formula: '\\(\\frac{d}{dx}(x^n) = nx^{n-1}\\)' },
            { function: '\\(f(x) = \\sqrt{x}\\)', type: 'Potencia', formula: '\\(\\frac{d}{dx}(x^n) = nx^{n-1}\\)' },
            { function: '\\(f(x) = 5x^3\\)', type: 'Múltiplo Constante', formula: '\\(\\frac{d}{dx}(cu) = cu\'\\)' },
            { function: '\\(f(x) = \\frac{x^2}{4}\\)', type: 'Función/Constante', formula: '\\(\\frac{d}{dx}\\left(\\frac{u}{c}\\right) = \\frac{u\'}{c}\\)' },
            { function: '\\(f(x) = \\frac{3}{x}\\)', type: 'Constante/Función', formula: '\\(\\frac{d}{dx}\\left(\\frac{c}{u}\\right) = -\\frac{cu\'}{u^2}\\)' },
            { function: '\\(f(x) = \\frac{5}{x^2}\\)', type: 'Constante/Función', formula: '\\(\\frac{d}{dx}\\left(\\frac{c}{u}\\right) = -\\frac{cu\'}{u^2}\\)' },
            { function: '\\(f(x) = (x^2 + 1)^3\\)', type: 'Potencia de Función', formula: '\\(\\frac{d}{dx}(u^n) = n \\cdot u^{n-1} \\cdot u\'\\)' },
            { function: '\\(f(x) = (3x - 2)^5\\)', type: 'Potencia de Función', formula: '\\(\\frac{d}{dx}(u^n) = n \\cdot u^{n-1} \\cdot u\'\\)' },
            { function: '\\(f(x) = (\\sin x)^2\\)', type: 'Potencia de Función', formula: '\\(\\frac{d}{dx}(u^n) = n \\cdot u^{n-1} \\cdot u\'\\)' },
            { function: '\\(f(x) = \\frac{x^2}{\\sin x}\\)', type: 'Cociente', formula: '\\(\\frac{d}{dx}\\left(\\frac{u}{v}\\right) = \\frac{u\' \\cdot v - u \\cdot v\'}{v^2}\\)' }
        ];

        const formulaOptions = [
            '\\(\\frac{d}{dx}(c) = 0\\)',
            '\\(\\frac{d}{dx}(x^n) = nx^{n-1}\\)',
            '\\(\\frac{d}{dx}(\\sin x) = \\cos x\\)',
            '\\(\\frac{d}{dx}(\\cos x) = -\\sin x\\)',
            '\\(\\frac{d}{dx}(\\tan x) = \\sec^2 x\\)',
            '\\(\\frac{d}{dx}(e^x) = e^x\\)',
            '\\(\\frac{d}{dx}(\\ln x) = \\frac{1}{x}\\)',
            '\\(\\frac{d}{dx}(u \\cdot v) = u\' \\cdot v + u \\cdot v\'\\)',
            '\\(\\frac{d}{dx}\\left(\\frac{u}{v}\\right) = \\frac{u\' \\cdot v - u \\cdot v\'}{v^2}\\)',
            '\\(\\frac{d}{dx}(cu) = cu\'\\)',
            '\\(\\frac{d}{dx}\\left(\\frac{u}{c}\\right) = \\frac{u\'}{c}\\)',
            '\\(\\frac{d}{dx}\\left(\\frac{c}{u}\\right) = -\\frac{cu\'}{u^2}\\)',
            '\\(\\frac{d}{dx}(u^n) = n \\cdot u^{n-1} \\cdot u\'\\)'
        ];

        let currentQuiz = [];

        function generateQuiz() {
            // Seleccionar 5 ejercicios aleatorios
            const shuffled = [...quizDatabase].sort(() => 0.5 - Math.random());
            currentQuiz = shuffled.slice(0, 5);

            const container = document.getElementById('quizContainer');
            container.innerHTML = '';

            currentQuiz.forEach((question, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'bg-white dark:bg-gray-800 rounded-xl p-6 shadow-lg';

                let optionsHTML = '';
                formulaOptions.forEach((option, optIndex) => {
                    optionsHTML += `
                        <label class="flex items-start space-x-3 p-3 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer transition-colors">
                            <input type="radio" name="q${index}" value="${optIndex}" class="mt-1">
                            <span class="text-base">${option}</span>
                        </label>
                    `;
                });

                questionDiv.innerHTML = `
                    <h3 class="text-lg font-bold mb-4 text-primary">Ejercicio ${index + 1}</h3>
                    <div class="mb-4 text-lg bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                        ${question.function}
                    </div>
                    <p class="font-semibold mb-3 text-base">Selecciona la fórmula correcta:</p>
                    <div class="space-y-2">
                        ${optionsHTML}
                    </div>
                `;

                container.appendChild(questionDiv);
            });

            document.getElementById('quizResults').classList.add('hidden');

            // Re-render MathJax
            if (window.MathJax) {
                MathJax.typesetPromise([container]);
            }
        }

        function checkAnswers() {
            let correct = 0;
            let results = '';

            currentQuiz.forEach((question, index) => {
                const selected = document.querySelector(`input[name="q${index}"]:checked`);
                const correctIndex = formulaOptions.indexOf(question.formula);

                if (selected && parseInt(selected.value) === correctIndex) {
                    correct++;
                    results += `<div class="bg-green-50 dark:bg-green-900/30 p-4 rounded-lg border-l-4 border-green-500 mb-3">
                        <p class="font-bold text-green-700 dark:text-green-400">✅ Ejercicio ${index + 1}: Correcto</p>
                        <p class="text-sm mt-1">${question.function} → ${question.formula}</p>
                    </div>`;
                } else {
                    results += `<div class="bg-red-50 dark:bg-red-900/30 p-4 rounded-lg border-l-4 border-red-500 mb-3">
                        <p class="font-bold text-red-700 dark:text-red-400">❌ Ejercicio ${index + 1}: Incorrecto</p>
                        <p class="text-sm mt-1"><strong>Fórmula correcta:</strong> ${question.formula}</p>
                    </div>`;
                }
            });

            const percentage = (correct / currentQuiz.length) * 100;
            let message = '';
            let bgClass = '';

            if (percentage >= 80) {
                message = '🎉 ¡Excelente! Dominas las fórmulas de derivadas.';
                bgClass = 'bg-green-100 dark:bg-green-900/30 border-green-500';
            } else if (percentage >= 60) {
                message = '👍 Buen trabajo, pero puedes mejorar. Revisa las fórmulas.';
                bgClass = 'bg-yellow-100 dark:bg-yellow-900/30 border-yellow-500';
            } else {
                message = '📚 Sigue practicando. Revisa la sección de Fórmulas.';
                bgClass = 'bg-red-100 dark:bg-red-900/30 border-red-500';
            }

            const resultsDiv = document.getElementById('quizResults');
            resultsDiv.className = `p-6 rounded-xl ${bgClass} border-l-4`;
            resultsDiv.innerHTML = `
                <h3 class="text-2xl font-bold mb-4">Resultados: ${correct}/${currentQuiz.length} (${percentage.toFixed(0)}%)</h3>
                <p class="text-lg mb-4">${message}</p>
                ${results}
            `;
            resultsDiv.classList.remove('hidden');

            // Re-render MathJax
            if (window.MathJax) {
                MathJax.typesetPromise([resultsDiv]);
            }
        }

        // Custom alert function
        function showCustomAlert(message) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4">
                    <p class="text-gray-700 dark:text-gray-300 mb-4 text-base">${message}</p>
                    <div class="flex justify-end">
                        <button class="px-4 py-2 bg-primary text-white hover:bg-purple-700 rounded" onclick="this.closest('.fixed').remove()">Aceptar</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Base de datos de 20 ejercicios para práctica
        const exercisesDatabase = [
            { function: '\\(f(x) = 12\\)', type: 'constante', formula: 'constante', answer: '0' },
            { function: '\\(f(x) = x\\)', type: 'identidad', formula: 'identidad', answer: '1' },
            { function: '\\(f(x) = x^6\\)', type: 'potencia', formula: 'potencia', answer: '6x^5' },
            { function: '\\(f(x) = 4x^3\\)', type: 'multiplo', formula: 'multiplo', answer: '12x^2' },
            { function: '\\(f(x) = \\frac{x^4}{3}\\)', type: 'funcion-constante', formula: 'funcion-constante', answer: '\\frac{4x^3}{3}' },
            { function: '\\(f(x) = \\frac{8}{x}\\)', type: 'constante-funcion', formula: 'constante-funcion', answer: '-\\frac{8}{x^2}' },
            { function: '\\(f(x) = \\frac{x^3}{x+2}\\)', type: 'cociente', formula: 'cociente', answer: '\\frac{2x^3+3x^2}{(x+2)^2}' },
            { function: '\\(f(x) = (x^2-1)^4\\)', type: 'potencia-funcion', formula: 'potencia-funcion', answer: '8x(x^2-1)^3' },
            { function: '\\(f(x) = x^5 + 2x^3 - 7\\)', type: 'suma', formula: 'suma', answer: '5x^4+6x^2' },
            { function: '\\(f(x) = x^3(2x-5)\\)', type: 'producto', formula: 'producto', answer: '8x^3-15x^2' },
            { function: '\\(f(x) = x^{-2}\\)', type: 'potencia', formula: 'potencia', answer: '-2x^{-3}' },
            { function: '\\(f(x) = -6x^5\\)', type: 'multiplo', formula: 'multiplo', answer: '-30x^4' },
            { function: '\\(f(x) = \\frac{x^2}{5}\\)', type: 'funcion-constante', formula: 'funcion-constante', answer: '\\frac{2x}{5}' },
            { function: '\\(f(x) = \\frac{3}{x^3}\\)', type: 'constante-funcion', formula: 'constante-funcion', answer: '-\\frac{9}{x^4}' },
            { function: '\\(f(x) = \\frac{2x}{x^2+4}\\)', type: 'cociente', formula: 'cociente', answer: '\\frac{8-2x^2}{(x^2+4)^2}' },
            { function: '\\(f(x) = (3x+1)^2\\)', type: 'potencia-funcion', formula: 'potencia-funcion', answer: '6(3x+1)' },
            { function: '\\(f(x) = 3x^4 - x^2 + 5x\\)', type: 'suma', formula: 'suma', answer: '12x^3-2x+5' },
            { function: '\\(f(x) = (x+1)(x^2-3)\\)', type: 'producto', formula: 'producto', answer: '3x^2+2x-3' },
            { function: '\\(f(x) = \\sqrt{x}\\)', type: 'potencia', formula: 'potencia', answer: '\\frac{1}{2\\sqrt{x}}' },
            { function: '\\(f(x) = (x^3+2)^3\\)', type: 'potencia-funcion', formula: 'potencia-funcion', answer: '9x^2(x^3+2)^2' }
        ];

        const typeOptions = [
            { value: '', label: 'Selecciona...' },
            { value: 'constante', label: 'Constante' },
            { value: 'identidad', label: 'Identidad' },
            { value: 'potencia', label: 'Potencia' },
            { value: 'multiplo', label: 'Múltiplo Constante' },
            { value: 'funcion-constante', label: 'Función/Constante (u/c)' },
            { value: 'constante-funcion', label: 'Constante/Función (c/u)' },
            { value: 'cociente', label: 'Cociente (u/v)' },
            { value: 'potencia-funcion', label: 'Potencia de Función (u^n)' },
            { value: 'suma', label: 'Suma/Resta' },
            { value: 'producto', label: 'Producto' }
        ];

        const formulaOptionsSelect = [
            { value: '', label: 'Selecciona...' },
            { value: 'constante', label: 'd/dx(c) = 0' },
            { value: 'identidad', label: 'd/dx(x) = 1' },
            { value: 'potencia', label: 'd/dx(x^n) = nx^(n-1)' },
            { value: 'multiplo', label: 'd/dx(cu) = cu\'' },
            { value: 'funcion-constante', label: 'd/dx(u/c) = u\'/c' },
            { value: 'constante-funcion', label: 'd/dx(c/u) = -cu\'/u²' },
            { value: 'cociente', label: 'd/dx(u/v) = (u\'v - uv\')/v²' },
            { value: 'potencia-funcion', label: 'd/dx(u^n) = nu^(n-1)u\'' },
            { value: 'suma', label: 'd/dx(u±v) = u\'±v\'' },
            { value: 'producto', label: 'd/dx(uv) = u\'v + uv\'' }
        ];

        function displayExercises() {
            const container = document.getElementById('exercisesContainer');
            container.innerHTML = '';

            exercisesDatabase.forEach((exercise, index) => {
                const exerciseDiv = document.createElement('div');
                exerciseDiv.className = 'bg-white dark:bg-gray-800 rounded-xl p-6 shadow-lg';

                // Generar opciones para tipo
                const typeOptionsHTML = typeOptions.map(opt =>
                    `<option value="${opt.value}">${opt.label}</option>`
                ).join('');

                // Generar opciones para fórmula
                const formulaSelectOptionsHTML = formulaOptionsSelect.map(opt =>
                    `<option value="${opt.value}">${opt.label}</option>`
                ).join('');

                exerciseDiv.innerHTML = `
                    <div class="flex items-center gap-4 mb-4">
                        <div class="w-12 h-12 bg-primary text-white rounded-full flex items-center justify-center font-bold text-lg">
                            ${index + 1}
                        </div>
                        <div class="flex-1">
                            <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg text-lg">
                                ${exercise.function}
                            </div>
                        </div>
                    </div>

                    <div class="grid md:grid-cols-3 gap-4 mt-4">
                        <div class="bg-blue-50 dark:bg-blue-900/20 p-3 rounded border-l-4 border-blue-500">
                            <p class="text-sm font-semibold text-blue-700 dark:text-blue-300 mb-2">Paso 1: Identificación</p>
                            <select id="type-${index}" class="w-full px-3 py-2 text-base border-2 border-blue-300 dark:border-blue-700 rounded-lg bg-white dark:bg-gray-700 focus:border-primary focus:outline-none">
                                ${typeOptionsHTML}
                            </select>
                        </div>
                        <div class="bg-purple-50 dark:bg-purple-900/20 p-3 rounded border-l-4 border-purple-500">
                            <p class="text-sm font-semibold text-purple-700 dark:text-purple-300 mb-2">Paso 2: Fórmula</p>
                            <select id="formula-${index}" class="w-full px-3 py-2 text-base border-2 border-purple-300 dark:border-purple-700 rounded-lg bg-white dark:bg-gray-700 focus:border-primary focus:outline-none">
                                ${formulaSelectOptionsHTML}
                            </select>
                        </div>
                        <div class="bg-green-50 dark:bg-green-900/20 p-3 rounded border-l-4 border-green-500">
                            <p class="text-sm font-semibold text-green-700 dark:text-green-300 mb-2">Paso 3: Respuesta</p>
                            <input type="text" id="answer-${index}" placeholder="f'(x) = ..." class="w-full px-3 py-2 text-base border-2 border-green-300 dark:border-green-700 rounded-lg bg-white dark:bg-gray-700 focus:border-primary focus:outline-none">
                        </div>
                    </div>

                    <div id="result-${index}" class="mt-4 hidden"></div>
                `;

                container.appendChild(exerciseDiv);
            });

            // Agregar botón de verificar al final
            const buttonDiv = document.createElement('div');
            buttonDiv.className = 'flex justify-center mt-8';
            buttonDiv.innerHTML = `
                <button onclick="checkExercises()" class="bg-gradient-to-r from-primary to-purple-600 text-white px-8 py-4 rounded-lg font-bold hover:shadow-lg transition-all text-lg">
                    ✅ Verificar Todos los Ejercicios
                </button>
            `;
            container.appendChild(buttonDiv);

            // Re-render MathJax
            if (window.MathJax) {
                MathJax.typesetPromise([container]);
            }
        }

        function checkExercises() {
            let totalCorrect = 0;
            let totalAnswered = 0;

            exercisesDatabase.forEach((exercise, index) => {
                const selectedType = document.getElementById(`type-${index}`).value;
                const selectedFormula = document.getElementById(`formula-${index}`).value;
                const userAnswer = document.getElementById(`answer-${index}`).value.trim();
                const resultDiv = document.getElementById(`result-${index}`);

                if (!selectedType && !selectedFormula && !userAnswer) {
                    resultDiv.classList.add('hidden');
                    return;
                }

                totalAnswered++;

                const typeCorrect = selectedType === exercise.type;
                const formulaCorrect = selectedFormula === exercise.formula;

                // Normalizar respuestas para comparación (quitar espacios y hacer case-insensitive)
                const normalizedUserAnswer = userAnswer.replace(/\s+/g, '').toLowerCase();
                const normalizedCorrectAnswer = exercise.answer.replace(/\s+/g, '').toLowerCase();
                const answerCorrect = normalizedUserAnswer === normalizedCorrectAnswer;

                const allCorrect = typeCorrect && formulaCorrect && answerCorrect;

                if (allCorrect) {
                    totalCorrect++;
                }

                let resultHTML = '<div class="p-4 rounded-lg border-l-4 ';

                if (allCorrect) {
                    resultHTML += 'bg-green-50 dark:bg-green-900/20 border-green-500">';
                    resultHTML += '<p class="font-bold text-green-700 dark:text-green-400">✅ ¡Excelente! Todo correcto</p>';
                } else {
                    resultHTML += 'bg-red-50 dark:bg-red-900/20 border-red-500">';
                    resultHTML += '<p class="font-bold text-red-700 dark:text-red-400">❌ Hay errores. Revisa:</p>';
                    resultHTML += '<ul class="mt-2 space-y-1 text-sm">';

                    if (!typeCorrect) {
                        const correctTypeLabel = typeOptions.find(opt => opt.value === exercise.type)?.label || exercise.type;
                        resultHTML += `<li>• <strong>Tipo:</strong> Debería ser "${correctTypeLabel}"</li>`;
                    }
                    if (!formulaCorrect) {
                        const correctFormulaLabel = formulaOptionsSelect.find(opt => opt.value === exercise.formula)?.label || exercise.formula;
                        resultHTML += `<li>• <strong>Fórmula:</strong> Debería ser "${correctFormulaLabel}"</li>`;
                    }
                    if (!answerCorrect && userAnswer) {
                        resultHTML += `<li>• <strong>Respuesta:</strong> La respuesta correcta es \\(f'(x) = ${exercise.answer}\\)</li>`;
                    }

                    resultHTML += '</ul>';
                }

                resultHTML += '</div>';

                resultDiv.innerHTML = resultHTML;
                resultDiv.classList.remove('hidden');

                // Re-render MathJax para este resultado
                if (window.MathJax) {
                    MathJax.typesetPromise([resultDiv]);
                }
            });

            // Mostrar resumen general
            if (totalAnswered > 0) {
                const percentage = (totalCorrect / totalAnswered * 100).toFixed(0);
                let message = '';
                let alertClass = '';

                if (percentage >= 80) {
                    message = `🎉 ¡Excelente trabajo! ${totalCorrect}/${totalAnswered} correctos (${percentage}%)`;
                    alertClass = 'bg-green-100 dark:bg-green-900/30 border-green-500 text-green-800 dark:text-green-300';
                } else if (percentage >= 60) {
                    message = `👍 Buen intento! ${totalCorrect}/${totalAnswered} correctos (${percentage}%). Sigue practicando.`;
                    alertClass = 'bg-yellow-100 dark:bg-yellow-900/30 border-yellow-500 text-yellow-800 dark:text-yellow-300';
                } else {
                    message = `📚 ${totalCorrect}/${totalAnswered} correctos (${percentage}%). Revisa las fórmulas y vuelve a intentarlo.`;
                    alertClass = 'bg-red-100 dark:bg-red-900/30 border-red-500 text-red-800 dark:text-red-300';
                }

                showCustomAlert(message);
            } else {
                showCustomAlert('Por favor completa al menos un ejercicio antes de verificar.');
            }
        }

        // Inicializar ejercicios
        displayExercises();

        // Generar quiz inicial
        generateQuiz();

        // Función para mostrar modal de fórmula
        function showFormulaModal(title, formula, explanation, examples) {
            const modal = document.createElement('div');
            modal.className = 'formula-modal';
            modal.onclick = function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            };

            const content = document.createElement('div');
            content.className = 'formula-modal-content';
            content.onclick = function(e) {
                e.stopPropagation();
            };

            content.innerHTML = `
                <div class="text-center">
                    <div class="inline-block bg-gradient-to-r from-primary to-purple-600 text-white px-6 py-3 rounded-full mb-6">
                        <h2 class="text-2xl font-bold">${title}</h2>
                    </div>

                    <div class="bg-gradient-to-br from-blue-50 to-purple-50 dark:from-blue-900/20 dark:to-purple-900/20 p-8 rounded-xl mb-6 border-4 border-primary">
                        <div class="text-4xl md:text-5xl math-formula" style="color: #5D5CDE;">
                            ${formula}
                        </div>
                    </div>

                    <div class="bg-blue-50 dark:bg-blue-900/20 p-6 rounded-xl mb-4 text-left border-l-4 border-blue-500">
                        <p class="text-lg font-semibold mb-2 text-blue-700 dark:text-blue-300">💡 Explicación:</p>
                        <p class="text-base">${explanation}</p>
                    </div>

                    <div class="bg-green-50 dark:bg-green-900/20 p-6 rounded-xl mb-6 text-left border-l-4 border-green-500">
                        <p class="text-lg font-semibold mb-2 text-green-700 dark:text-green-300">📝 Ejemplos:</p>
                        <div class="text-base">${examples}</div>
                    </div>

                    <button onclick="this.closest('.formula-modal').remove()"
                            class="bg-gradient-to-r from-primary to-purple-600 text-white px-8 py-3 rounded-full font-bold hover:shadow-lg transition-all text-lg">
                        ✕ Cerrar
                    </button>
                </div>
            `;

            modal.appendChild(content);
            document.body.appendChild(modal);

            // Re-render MathJax
            if (window.MathJax) {
                MathJax.typesetPromise([modal]);
            }
        }

        // Agregar interactividad a todas las tarjetas de fórmulas
        document.addEventListener('DOMContentLoaded', function() {
            const formulaCards = document.querySelectorAll('.formula-card');

            formulaCards.forEach(card => {
                // Si ya tiene onclick, no hacer nada
                if (card.onclick) return;

                // Agregar hint si no lo tiene
                if (!card.querySelector('.click-hint')) {
                    const hint = document.createElement('span');
                    hint.className = 'click-hint';
                    hint.textContent = '👆 Click';
                    card.insertBefore(hint, card.firstChild);
                }

                // Agregar emoji al título si no lo tiene
                const title = card.querySelector('h3');
                if (title && !title.textContent.includes('🔷')) {
                    title.textContent = '🔷 ' + title.textContent;
                }

                // Extraer información de la tarjeta
                const titleText = title ? title.textContent.replace('🔷 ', '') : 'Fórmula';
                const formulaDiv = card.querySelector('.math-formula');
                const formula = formulaDiv ? formulaDiv.innerHTML : '';
                const exampleP = card.querySelector('p.text-sm');
                const examples = exampleP ? exampleP.innerHTML : 'Ver sección de ejercicios para más ejemplos.';

                // Crear explicaciones personalizadas
                let explanation = 'Esta es una fórmula fundamental del cálculo diferencial.';

                if (titleText.toLowerCase().includes('constante')) {
                    explanation = 'La derivada de cualquier número constante siempre es cero, porque las constantes no cambian.';
                } else if (titleText.toLowerCase().includes('identidad')) {
                    explanation = 'La derivada de x con respecto a x es 1, porque x cambia a una tasa constante de 1.';
                } else if (titleText.toLowerCase().includes('potencia')) {
                    explanation = 'Multiplica por el exponente y resta 1 al exponente. Esta es una de las reglas más usadas.';
                } else if (titleText.toLowerCase().includes('múltiplo')) {
                    explanation = 'La constante sale fuera de la derivada. Deriva la función y multiplica por la constante.';
                } else if (titleText.toLowerCase().includes('suma') || titleText.toLowerCase().includes('resta')) {
                    explanation = 'Deriva cada término por separado y conserva los signos de suma o resta.';
                } else if (titleText.toLowerCase().includes('producto')) {
                    explanation = 'Deriva la primera función y multiplícala por la segunda, más la primera por la derivada de la segunda.';
                } else if (titleText.toLowerCase().includes('cociente')) {
                    explanation = 'Regla del cociente: "Abajo por arriba prima, menos arriba por abajo prima, todo sobre abajo al cuadrado".';
                } else if (titleText.toLowerCase().includes('cadena')) {
                    explanation = 'Deriva la función exterior evaluada en la interior, multiplicada por la derivada de la función interior.';
                } else if (titleText.toLowerCase().includes('seno')) {
                    explanation = 'La derivada del seno es el coseno.';
                } else if (titleText.toLowerCase().includes('coseno')) {
                    explanation = 'La derivada del coseno es menos seno. No olvides el signo negativo.';
                } else if (titleText.toLowerCase().includes('tangente')) {
                    explanation = 'La derivada de la tangente es secante al cuadrado.';
                } else if (titleText.toLowerCase().includes('exponencial')) {
                    explanation = 'La función exponencial natural e^x es especial: ¡es su propia derivada!';
                } else if (titleText.toLowerCase().includes('logaritmo')) {
                    explanation = 'La derivada del logaritmo natural es uno sobre x.';
                }

                card.onclick = function() {
                    showFormulaModal(titleText, formula, explanation, examples);
                };
            });
        });

        // Permitir Enter en el input
        document.getElementById('functionInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                analyzeFunction();
            }
        });
    </script>
</body>
</html>
